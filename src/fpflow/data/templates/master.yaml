#region: basic info 
structures:
  active_idx: 0
  list:
    - name: 'Si'
      file:
        # type: 'mpapi-id'        # localfile, mpapi-id, mpapi-formula. Set MP_API in environment if using mp. 
        # value: 'mp-149'
      cell:
        unit: angstrom  # angstrom, bohr, alat. 
        read_if_relaxed: true
        # Specify either 'vectors' or 'bravais_lattice_info'
        # vectors:
        #   - [5.45, 5.43, 0.0]
        #   - [0.0, 5.43, 5.43]
        #   - [5.43, 0.0, 5.43]
        bravais_lattice_info:
          ibrav: 'fcc'
          A: 5.43
      positions:
        unit: crystal   # angstrom, bohr, crystal, alat. 
        read_if_relaxed: true
        coords:
          - ['Si', 0.00, 0.00, 0.00]
          - ['Si', 0.25, 0.25, 0.25]  
        # vca:    # Virtual crystal approximation. 
        #   - ['Si', 'Ag', 0.2]
      # supercell_size: [2, 2, 2]
    - name: 'Si'
      file:
        # type: 'mpapi-formula'        # localfile, mpapi-id, mpapi-formula. Set MP_API in environment if using mp. 
        # value: 'Si'
      cell:
        unit: angstrom  # angstrom, bohr, alat. 
        read_if_relaxed: true
        # Specify either 'vectors' or 'bravais_lattice_info'
        # vectors:
        #   - [5.45, 5.43, 0.0]
        #   - [0.0, 5.43, 5.43]
        #   - [5.43, 0.0, 5.43]
        bravais_lattice_info:
          ibrav: 'fcc'
          A: 5.45
      positions:
        unit: crystal   # angstrom, bohr, crystal, alat. 
        read_if_relaxed: true
        coords:
          - ['Si', 0.00, 0.00, 0.00]
          - ['Si', 0.25, 0.25, 0.25]  
        # vca:    # Virtual crystal approximation. 
        #   - ['Si', 'Ag', 0.2]
      # supercell_size: [2, 2, 2]

kpath:
  special_points:
    - 'L'
    - 'G'
    - 'X'
    - 'W'
    - 'U'
    - 'L'
    - 'K'
    - 'G'
  npoints_segment: 10  

common:
  qshift: &qshift [0.000, 0.000, 0.001]
  
  coarse_sym: &coarse_sym true
  coarse_kgrid: &coarse_kgrid [2, 2, 2]
  coarse_nk: &coarse_nk 8

  fine_sym: &fine_sym false
  fine_kgrid: &fine_kgrid [2, 2, 2]
  fine_nk: &fine_nk 8
  
  qgrid: &qgrid [2, 2, 2]
  dfpt_ni_nodes_auto_assign: &dfpt_ni_nodes_auto_assign true 
  epw_nodes: &epw_nodes 1
  epw_nk: &epw_nk 8

  dft:
    ecut: &dft_ecut 20.0
    kgrid: &scf_kgrid [2, 2, 2]
    val_bands: &dft_valbands 4
    cond_bands: &dft_condbands 4
    xc: &dft_xc 'pbe'  # pbe, lda. 
    is_spinorbit: &dft_spinorbit false
  gw:
    ecut: &gwecut 10.0
    val_bands: &gw_valbands 4
    cond_bands: &gw_condbands 4
    para_cond_bands: &gw_para_condbands 201
    use_pseudobands: &use_pseudobands true
    conv_cond_bands: &gw_conv_condbands 200
  gwelbands:
    val_bands: &gwelbands_valbands 3
    cond_bands: &gwelbands_condbands 3
  bse:
    val_bands: &bse_valbands 4
    cond_bands: &bse_condbands 4
    nxct: &bse_nxct 10
    supercell_size: &xct_supercell_size [2, 2, 2]
    hole_position: &xct_hole_position [0.00, 0.00, 0.00]
    elec_position: &xct_elec_position [0.25, 0.25, 0.25]
    xct_state: &xct_state 1
    spinor: &plotxct_spinor # Only activated in spin orbit coupling mode. 1 is up, 2 is down.
      electron_spin: 1      
      hole_spin: 2
  job_types:
    scheduler: &scheduler_dict
      name: &scheduler_name 'mac_mini_parallel'
      is_interactive: true
    interactive:
      nodes: &interactive_nodes 1
      time: &interactive_time 03:40:00
    single:
      nodes: &single_nodes 1
      ntasks: &single_ntasks 1
      time: &single_time "02:45:00"
    para:
      nodes: &para_nodes 1
      ntasks: &para_ntasks 1
      time: &para_time "02:45:00"
    big:
      nodes: &big_nodes 1
      ntasks: &big_ntasks 1
      time: &big_time "02:45:00"

generator:
  dest_dir: ./
  pre_steps:
    - pseudos_qe
  steps: &gen_steps
  #  - esr_gen
  #  - relax_qe
  #  - cdft_qe
  #  - md_qe
   - scf_qe
  #  - scf_abacus
  #  - scf_siesta
  #  - dftelbands_qe
   - nscf_qe
  #  - nscf_abacus
  #  - nscf_siesta
  #  - dos_qe 
  #  - pdos_qe 
  #  - kpdos_qe 
  #  - wannier_qe
  #  - dfpt_qe
  #  - pp_dfpt_qe
  #  - phbands_qe 
  #  - phdos_qe 
  #  - phmodes_qe  
  #  - epw_qe
  #  - elph_epw 
  #  - pol_epw
  #  - phonopy_qe 
   - epsilon_bgw 
  #  - sigmasc_bgw. Repeat this and below as many times as needed for scGW. 
   - sigma_bgw
  #  - gwelbands_bgw 
   - kernel_bgw
   - absorption_bgw 
   - plotxct_bgw 
  #  - bseq_bgw
  #  - bseq_epw
  #  - wannier_bgw 
  #  - bseq_waninterp_bgw
  #  - xctph_fp 
  #  - xctph_epw
  #  - xctpol_fp
  #  - ste_fp  
  #  - ste_epw
  #  - zd_epw
  #  - dmc_xctph_fp
  #  - esf_fp
  #  - esr_fp 
  #  - convergence_scf_qe
  #  - convergence_dfpt_qe
  #  - convergence_gw_qe
  #  - convergence_bse_qe
  post_steps:
    - create_script
    - run_script
    - remove_script
    - plot_script
    - interactive_script

manager:
  dest_dir: ./
  steps: *gen_steps
  plots: *gen_steps
#endregion: basic info

job_types:
  interactive:
    name: *scheduler_name
    is_interactive: true
    nodes: *interactive_nodes
    time: *interactive_time
  single_task: &single_task
    <<: *scheduler_dict
    nodes: 1
    ntasks: 1
    time: *single_time
  single_node: &single_node
    <<: *scheduler_dict
    nodes: 1
    ntasks: *single_ntasks
    time: *single_time
  para: &para
    <<: *scheduler_dict
    nodes: *para_nodes
    ntasks: *para_ntasks
    time: *para_time
  para_k: &para_k
    <<: *scheduler_dict
    nodes: *para_nodes
    ntasks: *para_ntasks
    time: *para_time
  big_para: &big_para
    <<: *scheduler_dict
    nodes: *big_nodes
    ntasks: *big_ntasks
    time: *big_time
  big_para_k: &big_para_k
    <<: *scheduler_dict
    nodes: *big_nodes
    ntasks: *big_ntasks
    time: *big_time
  para_epwk: &para_epwk
    <<: *scheduler_dict
    nodes: *epw_nodes
    ntasks: *epw_nk
    nk: *epw_nk
    time: *big_time

relax:
  type: 'vc-relax'  # Options are: relax, vcrelax, cdft-relax, cdft-vcrelax.  
  update_coord: true
  args:
  job_info:
    <<: *para
cdft:
  type: 'vc-relax'
  update_coord: false
  excited_cond_band: 1 # relative to the fermi level. 1 start index
  removed_val_band: -1  # relative to the fermi level. 1 start index 
  args:
  job_info:
    <<: *para
md:
  kgrid: *coarse_kgrid
  type: 'md'      # Can be md or vc-md. 
  time_step: 20   # 20 a.u. a.u = 48 as. 
  nsteps: 100
  temp: 300
  structure_index: 0    # Choose which structure index to start with for md. 0 index based.
  args:
  job_info:
    <<: *para
scf:
  kgrid: *scf_kgrid
  ecut: *dft_ecut
  is_spinorbit: *dft_spinorbit
  xc: *dft_xc
  run_pw2bgw: true
  args:
  pw2bgw_args:
  job_info:
    <<: *para
  job_pw2bgw_info:
    <<: *single_node
dftelbands:
  val_bands: *dft_valbands
  cond_bands: *dft_condbands
  pw2bgw_args:
  job_pw2bgw_info:
    <<: *para
  args:
  job_info:
    <<: *para
nscf:
  list:
    - name: 'wfn'
      kgrid: *coarse_kgrid
      qshift: [0.0, 0.0, 0.0]
      sym: *coarse_sym
      cond_bands: *gw_condbands
      extract_rho_vxc_vsc_vkb: true
      parabands:
        enabled: true
        cond_bands: *gw_para_condbands
        use_pseudobands: *use_pseudobands
        parabands_args:
        job_parabands_info:
          <<: *para
      pw2bgw_args:
      args:
      job_pw2bgw_info:
        <<: *para
      job_info:
        <<: *para
    - name: 'wfnq'
      kgrid: *coarse_kgrid
      qshift: *qshift
      sym: *coarse_sym
      cond_bands: *gw_condbands
      extract_rho_vxc_vsc_vkb: false
      parabands:
        enabled: false
        cond_bands: 
        use_pseudobands:
        parabands_args:
        job_parabands_info:
      pw2bgw_args:
      args:
      job_pw2bgw_info:
        <<: *para
      job_info:
        <<: *para
    - name: 'wfnfi'
      kgrid: *fine_kgrid
      qshift: [0.0, 0.0, 0.0]
      sym: *fine_sym
      cond_bands: *gw_condbands
      extract_rho_vxc_vsc_vkb: false
      parabands:
        enabled: false
        cond_bands: 
        use_pseudobands:
        parabands_args:
        job_parabands_info:
      pw2bgw_args:
      args:
      job_pw2bgw_info:
        <<: *para
      job_info:
        <<: *para
    - name: 'wfnqfi'
      kgrid: *fine_kgrid
      qshift: *qshift
      sym: *fine_sym
      cond_bands: *gw_condbands
      extract_rho_vxc_vsc_vkb: false
      parabands:
        enabled: false
        cond_bands: 
        use_pseudobands:
        parabands_args:
        job_parabands_info:
      pw2bgw_args:
      args:
      job_pw2bgw_info:
        <<: *para
      job_info:
        <<: *para
    - name: 'wfnwannier'
      kgrid: *fine_kgrid
      qshift: [0.0, 0.0, 0.0]
      sym: *fine_sym
      cond_bands: *gw_condbands
      extract_rho_vxc_vsc_vkb: false
      parabands:
        enabled: false
        cond_bands: 
        use_pseudobands:
        parabands_args:
        job_parabands_info:
      pw2bgw_args:
      args:
      job_pw2bgw_info:
        <<: *para
      job_info:
        <<: *para
dos:
  kgrid: *coarse_kgrid
  cond_bands: *dft_condbands
  wfn_args:
  args:
  job_wfndos_info:
    <<: *para
  job_info:
    <<: *para
pdos:
  plot:
    filter_regex: '2\(Si\)'
  args:
  job_info:
    <<: *para
kpdos:
  plot:
    scatter_scale_factor: 1.0
    filter_regex: '2\(Si\)'
  args:
  job_info:
    <<: *para
wannier:
  nscflink_dir: ../wfnwannier/tmp
  kgrid: *fine_kgrid
  val_bands: *dft_valbands
  cond_bands: *dft_condbands
  
  pw2wan_args:
  args:

  job_wanpp_info:
    <<: *single_task
  job_pw2wan_info:
    <<: *single_node
  job_info:
    <<: *single_node
dfpt:
  qgrid: *qgrid
  auto_assign_ni_and_nodes: *dfpt_ni_nodes_auto_assign
  conv_thr: '1.0d-16'
  args:
  job_info:
    <<: *big_para
phbands:
  q2r_args:
  matdyn_args:
  job_info:
    <<: *single_node
phdos:
  qgrid: *qgrid
  q2r_args:
  matdyn_args:
  job_info:
    <<: *single_node
phmodes:
  qpt_idx: 1
  args:
  job_info:
    <<: *single_node
phonopy:
  job_info:
    <<: *big_para
epw:
  kgrid: *fine_kgrid
  qgrid: *qgrid
  val_bands: *bse_valbands
  cond_bands: *bse_condbands
  args:
  job_info:
    <<: *para_epwk
elph:
  job_info:
    <<: *big_para
gw:
  epsilon:
    ecut: *gwecut
    cond_bands: *gw_conv_condbands
    wfnlink: 'wfn'
    wfnqlink: 'wfnq'
    args:
    job_info:
      <<: *big_para
  sigma:
    ecut: *gwecut
    conv_cond_bands: *gw_conv_condbands
    cond_bands: *gw_condbands
    val_bands: *gw_valbands
    wfnlink: 'wfn'
    args:
    job_info:
      <<: *big_para
  gwelbands:
    val_bands: *gwelbands_valbands
    cond_bands: *gwelbands_condbands
    wfnco_link: 'wfn'
    wfnfi_link: 'dftelbands'
    args:
    job_info:
      <<: *para
bse:
  kernel:
    qshift: [0.0, 0.0, 0.0]
    args:
    job_info:
      <<: *big_para
  absorption:
    qshift: [0.0, 0.0, 0.0]
    val_bands: *bse_valbands
    cond_bands: *bse_condbands
    nxct: *bse_nxct
    pol_dir: *qshift
    wfnco_link: 'wfn'
    wfnqco_link: 'wfnq'
    wfnfi_link: 'wfn'
    wfnqfi_link: 'wfnq'
    args:
    job_info:
      <<: *para
  plotxct:
    hole_position: *xct_hole_position
    supercell_size: *xct_supercell_size
    elec_position: *xct_elec_position
    xct_state: *xct_state
    spinor: *plotxct_spinor
    args:
    job_info:
      <<: *big_para
bseq:
  sym: *fine_sym
  qgrid: *fine_kgrid
  job_info:
    <<: *big_para
xctph:
  val_bands: *bse_valbands
  cond_bands: *bse_condbands
  kgrid: *fine_kgrid
  qgrid: *qgrid
  nxct: *bse_nxct
  args:
  job_info:
    <<: *big_para
xctpol:
  nxct: *bse_nxct
  temp: 300
  max_error: 1e-2
  max_steps: 10
  job_info:
    <<: *big_para
ste:
  val_bands: *bse_valbands
  cond_bands: *bse_condbands
  kgrid: *fine_kgrid
  qgrid: *qgrid
  nxct: *bse_nxct
  max_error: 1e-2
  max_steps: 30
  temp: 300
  args:
  job_info:
    <<: *big_para
zd:
  args_xctph:
  args_ste:
  job_info:
    <<: *big_para
  job_epw_info:
    <<: *para_epwk
esf:
  job_info:
    <<: *big_para
esr:
  supercell_size: [2, 2, 2]
  max_error: 1e-3
  max_steps: 3
  job_info:
    <<: *big_para
mldftqe:
  job_info:
    <<: *big_para
convergence:
  qescf:
    dir_list:
      # dset_0
      - dirname: 'dset_0'
        params:
          - path: 'scf.ecut'
            value: 10.0
          - path: 'scf.kgrid'
            value: [2, 2, 2]
        link_inodes:
        generator:
          pre_steps: ['pseudos_qe']
          steps: ['scf_qe', 'dftelbands_qe']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
      # dset_1
      - dirname: 'dset_1'
        params:
          - path: 'scf.ecut'
            value: 20.0
          - path: 'scf.kgrid'
            value: [2, 2, 2]
        link_inodes:
        generator:
          pre_steps: ['pseudos_qe']
          steps: ['scf_qe', 'dftelbands_qe']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
      # dset_2
      - dirname: 'dset_2'
        params:
          - path: 'scf.ecut'
            value: 20.0
          - path: 'scf.kgrid'
            value: [4, 4, 4]
        link_inodes:
        generator:
          pre_steps: ['pseudos_qe']
          steps: ['scf_qe', 'dftelbands_qe']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
    job_info:
      <<: *big_para
    plot:
      dirs: ['dset_1', 'dset_2']
  qedfpt:
    dir_list:
      # dset_00
      - dirname: 'dset_00'
        params:
          - path: 'relax.args.control.forc_conv_thr'
            value: '1.0d-3'
          - path: 'scf.ecut'
            value: 20.0
          - path: 'scf.args.electrons.conv_thr'
            value: '1.0d-6'
          - path: 'scf.kgrid'
            value: [2, 2, 2]
          - path: 'dfpt.conv_thr'
            value: '1.0d-14'
          - path: 'dfpt.qgrid'
            value: [2, 2, 2]
        link_inodes:
        generator:
          pre_steps: ['pseudos_qe']
          steps: ['relax_qe', 'scf_qe', 'dfpt_qe', 'phbands_qe']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
      # dset_01
      - dirname: 'dset_01'
        params:
          - path: 'relax.args.control.forc_conv_thr'
            value: '1.0d-3'
          - path: 'scf.ecut'
            value: 20.0
          - path: 'scf.args.electrons.conv_thr'
            value: '1.0d-8'
          - path: 'scf.kgrid'
            value: [2, 2, 2]
          - path: 'dfpt.conv_thr'
            value: '1.0d-14'
          - path: 'dfpt.qgrid'
            value: [2, 2, 2]
        link_inodes:
        generator:
          pre_steps: ['pseudos_qe']
          steps: ['relax_qe', 'scf_qe', 'dfpt_qe', 'phbands_qe']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
    job_info:
      <<: *big_para
  bgwgw:
    dir_list:
      # dset_0
      - dirname: 'dset_0'
        params:
          - path: 'scf.ecut'
            value: 20.0
          - path: 'scf.kgrid'
            value: [2, 2, 2]
          - path: 'wfn.kgrid'
            value: [2, 2, 2]
          - path: 'wfn.parabands_cond_bands'
            value: 101
          - path: 'wfnq.kgrid'
            value: [2, 2, 2]
          - path: 'gw.epsilon.ecut'
            value: 10.0
          - path: 'gw.epsilon.cond_bands'
            value: 100
          - path: 'gw.sigma.ecut'
            value: 10.0
          - path: 'gw.sigma.conv_cond_bands'
            value: 100
        link_inodes:
          - source: ../../qescf/dset_1/tmp
            dest: ./tmp
          - source: ../../qescf/dset_1/pseudos
            dest: ./pseudos
        generator:
          pre_steps: []
          steps: ['dftelbands_qe', 'wfn_qe', 'wfnq_qe', 'epsilon_bgw', 'sigma_bgw', 'gwelbands_bgw']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
      # dset_1
      - dirname: 'dset_1'
        params:
          - path: 'scf.ecut'
            value: 20
          - path: 'scf.kgrid'
            value: [2, 2, 2]
          - path: 'wfn.kgrid'
            value: [2, 2, 2]
          - path: 'wfn.parabands_cond_bands'
            value: 201
          - path: 'wfnq.kgrid'
            value: [2, 2, 2]
          - path: 'gw.epsilon.ecut'
            value: 10.0
          - path: 'gw.epsilon.cond_bands'
            value: 200
          - path: 'gw.sigma.ecut'
            value: 10.0
          - path: 'gw.sigma.conv_cond_bands'
            value: 200
        link_inodes:
          - source: ../../bgwgw/dset_0/tmp
            dest: ./tmp
          - source: ../../bgwgw/dset_0/pseudos
            dest: ./pseudos
        generator:
          pre_steps: []
          steps: ['dftelbands_qe', 'wfn_qe', 'wfnq_qe', 'epsilon_bgw', 'sigma_bgw', 'gwelbands_bgw']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
    job_info:
      <<: *big_para
  bgwbse:
    dir_list:
      # dset_0
      - dirname: 'dset_0'
        params:
          - path: 'scf.ecut'
            value: 20
          - path: 'scf.kgrid'
            value: [2, 2, 2]
          - path: 'wfn.kgrid'
            value: [2, 2, 2]
          - path: 'wfnq.kgrid'
            value: [2, 2, 2]
          - path: 'wfnfi.kgrid'
            value: [2, 2, 2]
          - path: 'wfnqfi.kgrid'
            value: [2, 2, 2]
          - path: 'gw.epsilon.ecut'
            value: 10.0
          - path: 'gw.epsilon.cond_bands'
            value: 200
          - path: 'gw.sigma.ecut'
            value: 10.0
          - path: 'gw.sigma.conv_cond_bands'
            value: 200
          - path: 'bse.absorption.val_bands'
            value: 2
          - path: 'bse.absorption.cond_bands'
            value: 2
        link_inodes:
          - source: ../../bgwgw/dset_1/tmp
            dest: ./tmp
          - source: ../../bgwgw/dset_1/pseudos
            dest: ./pseudos
          # - source: ../../bgwgw/dset_1/WFN_parabands.h5
          #   dest: ./WFN_parabands.h5
          # - source: ../../bgwgw/dset_1/WFNq_coo.h5
          #   dest: ./WFNq_coo.h5
          # - source: ../../bgwgw/dset_1/eqp1.dat
          #   dest: ./eqp1.dat
        generator:
          pre_steps: []
          steps: ['wfn_qe', 'wfnq_qe', 'epsilon_bgw', 'sigma_bgw', 'kernel_bgw', 'absorption_bgw']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
      # dset_1
      - dirname: 'dset_1'
        params:
          - path: 'scf.ecut'
            value: 20
          - path: 'scf.kgrid'
            value: [2, 2, 2]
          - path: 'wfn.kgrid'
            value: [3, 3, 3]
          - path: 'wfnq.kgrid'
            value: [3, 3, 3]
          - path: 'wfnfi.kgrid'
            value: [3, 3, 3]
          - path: 'wfnqfi.kgrid'
            value: [3, 3, 3]
          - path: 'gw.epsilon.ecut'
            value: 10.0
          - path: 'gw.epsilon.cond_bands'
            value: 200
          - path: 'gw.sigma.ecut'
            value: 10.0
          - path: 'gw.sigma.conv_cond_bands'
            value: 200
          - path: 'bse.absorption.val_bands'
            value: 2
          - path: 'bse.absorption.cond_bands'
            value: 2
        link_inodes:
          - source: ../../bgwgw/dset_1/tmp
            dest: ./tmp
          - source: ../../bgwgw/dset_1/pseudos
            dest: ./pseudos
          # - source: ../../bgwgw/dset_1/WFN_parabands.h5
          #   dest: ./WFN_parabands.h5
          # - source: ../../bgwgw/dset_1/WFNq_coo.h5
          #   dest: ./WFNq_coo.h5
          # - source: ../../bgwgw/dset_1/eqp1.dat
          #   dest: ./eqp1.dat
          # - source: ../../bgwbse/dset_0/WFN_fii.h5
          #   dest: ./WFN_fii.h5
          # - source: ../../bgwbse/dset_0/WFNq_fii.h5
          #   dest: ./WFNq_fii.h5
        generator:
          pre_steps: []
          steps: ['wfn_qe', 'wfnq_qe', 'epsilon_bgw', 'sigma_bgw', 'kernel_bgw', 'absorption_bgw']
          post_steps: ['create_script', 'run_script', 'remove_script', 'plot_script', 'interactive_script']
    job_info:
      <<: *big_para
    plot:
      eigs: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]